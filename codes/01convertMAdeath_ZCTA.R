###############################################################################
# Project: beta radiation and CVD death in MA
# Code: convert MA death record from one-row-per-person to one-row-per-zcta
# Input: "ma_2000_2015.sas7bdat"
# Output: "MAdeath_count_ZIP.rds"
# Author: Shuxin Dong                                                         
###############################################################################

## 0. set up ------------------------------------------------------------------
rm(list = ls())
gc()

setwd("/media/qnap3/Shuxin/ParticalRadiation_MAdeath/")

library(haven)
library(data.table)
library(tigris)
library(sf)
# library(icd)
library(sjlabelled)

## 1.ICD codes ---------------------------------------------------------
# - total cardiovascular disease (CVD): I00-I51
# - congestive heart failure (CHF): I50-I51
# - myocardial infarction (MI): I21-I22
# - stroke: I60-I69
# - all-cause mortality (TOT): A00-R99

## 2. load MA death records  --------------------------------------------------
origin <- read_sas("/media/qnap2/MortalityStates/GeocodedMortality/ma_2000_2015.sas7bdat")
get_label(origin)
# year 
# "Year of death" 
# date 
# "Date of death" 
# age 
# "Age in years" 
# sex 
# "Sex (1 = Male, 2 = Female)" 
# icd 
# "TRX_CAUSE_ACME" 
# lat 
# "Latitude" 
# long 
# "Longitude" 
# edu3 
# "Education recode (1 = Less than HS, 2 = HS, 3 = More than HS)" 
# race3 
# "Race recode (1 = White, 2 = Black, 3 = Other)" 
# fips 
# "FIPs County code, 5-digit number in text format" 
# ind 
# "Industry (text or number code of unknown nature)" 
# occ 
# "Occupation (text or number code of unknown nature)" 
# mar 
# "Marital Status (1 = never, 2 = married/separated, 3 = widowed, 4 = divorced)" 
# hisp 
# "Hispanic status (1 = yes, 0 = no)" 
# state 
# "Reporting State, as well as State of Residence, and State of Occurence" 
setDT(origin)

## add IDs
origin[, ID:=1:.N][]
dim(origin)
# [1] 805563     16

## only 2001-2015
origin <- origin[year(date) %in% 2001:2015,]
dim(origin)
# [1] 752805     16

## remove missing
cat("Number of individual missing location info:", sum(is.na(origin[,lat])), "/", dim(origin)[1], sum(is.na(origin[,lat]))/dim(origin)[1])
# Number of individual missing location info: 13636 / 752805 0.01811359
cat("Number of individual missing location info:", sum(is.na(origin[,long])), "/", dim(origin)[1], sum(is.na(origin[,long]))/dim(origin)[1])
# Number of individual missing location info: 13636 / 752805 0.01811359
cat("Number of individual missing ICD info:", sum(origin[,icd]==""), "/", dim(origin)[1], sum(origin[,icd]=="")/dim(origin)[1])
# Number of individual missing ICD info: 270 / 752805 0.0003586586

## missingness for loc and ICD
cat("Number of individual missing location info or ICD:", sum(is.na(origin[,lat])| origin[,icd]==""), "/", dim(origin)[1], sum(is.na(origin[,lat])| origin[,icd]=="")/dim(origin)[1])
# Number of individual missing location info or ICD: 13892 / 752805 0.01845365

mort <- na.omit(origin[,.(year, date, icd, lat, long, ID)])
mort <- mort[icd != "",]
dim(mort)
# [1] 738913      6
head(mort)
# year       date  icd      lat      long    ID
# 1: 2001 2001-04-01 J449 42.08182 -72.61861 52758
# 2: 2001 2001-04-01  F03 42.07359 -72.60768 52759
# 3: 2001 2001-04-01 J449 42.05481 -72.62351 52760
# 4: 2001 2001-08-01 I219 42.08514 -72.62851 52761
# 5: 2001 2001-12-01  F03 42.08185 -72.61878 52762
# 6: 2001 2001-02-01  I64 42.08078 -72.59399 52763

## 3. load ZCTA shape file - the 2010 version ---------------------------------
point_dt <- st_as_sf(mort, coords = c("long", "lat"), crs = 4326) # spatial data
download.file("ftp://ftp2.census.gov/geo/tiger/TIGER2010/ZCTA5/2010/tl_2010_25_zcta510.zip", "tl_2010_25_zcta510.zip")
unzip("tl_2010_25_zcta510.zip")
zcta_shp10 <- st_transform(sf::st_read("tl_2010_25_zcta510.shp"), 4326)
zcta10 <- st_join(point_dt, zcta_shp10, join = st_intersects)
setDT(zcta10)

## 4. aggregate MA death on ZCTA per year -------------------------------------
## assign ZCTA to each row of death record
mort_loc <- merge(mort, zcta10[, .(ID, ZCTA5CE10)], by = "ID")
## aggregate death records on ZCTA for year and month
dt <- mort_loc[, .(ID, year, date, icd, ZCTA5CE10)]
dt[, month := month(date)]
dt[, `:=` (icd_str1 = substr(icd,1,1),
           icd_str2 = substr(icd,1,2),
           icd_str3 = substr(icd,1,3))]
dt[, `:=` (CVD_TF = (icd_str2 %in% c("I0", "I1", "I2", "I3", "I4") | icd_str3 %in% c("I50", "I51")),
           MI_TF = icd_str3 %in% c("I21", "I22"),
           CHF_TF = icd_str3 %in% c("I50", "I51"),
           stroke_TF = icd_str3 %in% c("I60", "I61", "I62", "I63", "I64", "I65", "I66", "I67", "I68", "I69"),
           TOT_TF = icd_str1 %in% LETTERS[1:18])]

setorder(dt, year, month, ZCTA5CE10)[]
count <- dt[, .(CVD = sum(CVD_TF),
                MI = sum(MI_TF),
                CHF = sum(CHF_TF),
                stroke = sum(stroke_TF),
                TOT = sum(TOT_TF)), by = .(year, month, ZCTA5CE10)]
# > sum(count[,TOT])
# [1] 738913
sum(count[is.na(ZCTA5CE10),TOT])
# [1] 17 # number of individuals without assigned ZCTA
final <- na.omit(count)
sum(final[,TOT])
# [1] 738896
saveRDS(final, "/media/qnap3/Shuxin/ParticalRadiation_MAdeath/MAdeath_count_ZIP.rds")
